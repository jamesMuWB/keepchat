## 新增需求

### 需求:AES-256 加密算法

系统必须使用 AES-256-GCM 模式加密会话数据,提供机密性和完整性保护。

#### 场景:加密会话数据

- **当** 会话数据准备上传到云端
- **那么** 系统必须使用 AES-256-GCM 算法加密所有 JSON 数据

#### 场景:生成随机 IV

- **当** 执行加密操作
- **那么** 系统必须为每次加密生成新的随机初始化向量(IV),长度 12 字节

#### 场景:生成认证标签

- **当** 使用 GCM 模式加密
- **那么** 系统必须生成 16 字节的认证标签,用于验证数据完整性

#### 场景:解密会话数据

- **当** 从云端下载加密的会话数据
- **那么** 系统必须使用相同的密钥和 IV 解密数据并验证认证标签

### 需求:用户密码加密模式

系统必须支持用户提供密码加密会话,使用 PBKDF2 派生密钥。

#### 场景:使用密码派生密钥

- **当** 用户提供加密密码
- **那么** 系统必须使用 PBKDF2 算法(SHA-256,迭代 100000 次)从密码派生 256 位密钥

#### 场景:生成随机盐

- **当** 使用密码派生密钥
- **那么** 系统必须生成 16 字节的随机盐,并与加密数据一起存储

#### 场景:密码强度验证

- **当** 用户设置加密密码
- **那么** 系统必须验证密码长度至少 8 位,包含字母和数字

#### 场景:错误密码解密失败

- **当** 用户提供错误的解密密码
- **那么** 系统必须解密失败并提示"密码错误,请重试"

#### 场景:记住密码选项

- **当** 用户成功解密会话
- **那么** 系统必须提示用户可将密码转存为 `ENCRYPTION_API_KEY` 以便跨设备使用

### 需求:API Key 配置模式

系统必须支持通过配置 `ENCRYPTION_API_KEY` 作为会话加密密钥来源。

#### 场景:使用配置 API key

- **当** 用户在环境变量或配置文件中提供 `ENCRYPTION_API_KEY`
- **那么** 系统必须使用该 API key 通过 SHA-256 派生 256 位密钥用于加密/解密

#### 场景:未配置 API key

- **当** 用户未提供 `ENCRYPTION_API_KEY`
- **那么** 系统必须提示用户配置该值并拒绝继续加解密

#### 场景:更新 API key

- **当** 用户更新 `ENCRYPTION_API_KEY`
- **那么** 系统必须使用新 key 重新加密本地会话并上传云端

### 需求:密钥管理

系统必须提供密钥的导出、导入和轮换功能。

#### 场景:导出加密密钥

- **当** 用户运行 `/export-key`
- **那么** 系统必须导出当前加密密钥为 Base64 编码字符串,并警告妥善保管

#### 场景:导入加密密钥

- **当** 用户在新设备运行 `/import-key <base64-key>`
- **那么** 系统必须验证密钥格式并保存到本地配置文件

#### 场景:更换加密密钥

- **当** 用户运行 `/rotate-key`
- **那么** 系统必须生成新密钥,重新加密所有本地会话,并上传到云端

#### 场景:多设备密钥同步

- **当** 用户在设备 A 配置了 `ENCRYPTION_API_KEY`,在设备 B 需要访问
- **那么** 系统必须提示用户在设备 B 配置相同的 `ENCRYPTION_API_KEY`

### 需求:加密元数据管理

系统必须存储加密相关的元数据,如盐、IV、算法版本。

#### 场景:存储加密元数据

- **当** 加密会话数据
- **那么** 系统必须将盐、IV、算法标识(AES-256-GCM)、认证标签存储在元数据文件中

#### 场景:验证算法版本

- **当** 解密会话数据
- **那么** 系统必须检查算法版本,确保与当前支持的版本兼容

#### 场景:元数据损坏检测

- **当** 元数据文件损坏或缺失
- **那么** 系统必须拒绝解密并提示"加密元数据损坏,无法解密"

### 需求:数据完整性验证

系统必须验证加密数据的完整性,防止篡改。

#### 场景:验证认证标签

- **当** 解密会话数据
- **那么** 系统必须验证 GCM 认证标签,如果验证失败则拒绝解密

#### 场景:检测数据篡改

- **当** 加密数据被修改
- **那么** 系统必须通过认证标签检测到篡改,并警告"数据已被篡改,拒绝解密"

#### 场景:哈希值校验

- **当** 下载加密数据后
- **那么** 系统必须计算 SHA-256 哈希值,与元数据中的哈希值对比

### 需求:性能优化

系统必须优化加密性能,避免影响用户体验。

#### 场景:流式加密大文件

- **当** 会话数据超过 10MB
- **那么** 系统必须使用流式加密,避免一次性加载到内存

#### 场景:并行加密多个文件

- **当** 会话包含多个数据文件
- **那么** 系统必须并行加密多个文件以提升速度

#### 场景:加密进度反馈

- **当** 加密大型会话数据
- **那么** 系统必须显示加密进度百分比

### 需求:安全最佳实践

系统必须遵循加密安全最佳实践。

#### 场景:禁止弱密码

- **当** 用户尝试使用弱密码(如"123456"、"password")
- **那么** 系统必须拒绝并要求使用更强的密码

#### 场景:定期提示更换密钥

- **当** 密钥使用超过 365 天
- **那么** 系统必须提示用户考虑轮换密钥

#### 场景:内存中密钥清理

- **当** 加密或解密操作完成
- **那么** 系统必须立即清理内存中的密钥副本

#### 场景:禁止明文日志

- **当** 系统记录日志
- **那么** 系统必须禁止将密钥、密码、未加密的会话内容写入日志

## 修改需求

无

## 移除需求

无
