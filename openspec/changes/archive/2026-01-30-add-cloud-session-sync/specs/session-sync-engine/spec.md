## 新增需求

### 需求:收集会话数据

系统必须收集当前会话的所有相关数据,包括对话历史、工作上下文、文件引用和元数据。

#### 场景:收集完整会话数据

- **当** 用户触发会话同步
- **那么** 系统必须收集对话历史(所有消息)、工作上下文(当前文件、项目路径)、文件引用列表和元数据(会话ID、时间戳、设备信息)

#### 场景:收集空会话

- **当** 用户尝试同步没有任何对话的新会话
- **那么** 系统必须拒绝同步并提示会话为空

#### 场景:排除敏感文件内容

- **当** 会话引用了本地文件
- **那么** 系统必须仅存储文件路径和元数据,禁止上传完整文件内容(除非用户明确允许)

### 需求:会话数据压缩

系统必须使用 GZIP 压缩会话数据以减少存储空间和传输时间。

#### 场景:压缩会话数据

- **当** 系统准备上传会话数据
- **那么** 系统必须使用 GZIP 算法压缩 JSON 数据,压缩率必须达到 70% 以上

#### 场景:压缩大型会话

- **当** 会话包含超过 1000 条消息
- **那么** 系统必须成功压缩所有消息,不丢失任何数据

#### 场景:解压会话数据

- **当** 系统从云端下载压缩的会话数据
- **那么** 系统必须正确解压并还原原始 JSON 数据

### 需求:会话数据加密

系统必须在上传前加密会话数据,在下载后解密,使用 AES-256 加密算法。

#### 场景:使用用户密码加密

- **当** 用户提供了加密密码
- **那么** 系统必须使用该密码派生 AES-256 密钥,并加密会话数据

#### 场景:自动生成加密密钥

- **当** 用户未提供加密密码
- **那么** 系统必须自动生成随机加密密钥并安全存储在本地 keychain 中

#### 场景:加密后数据无法读取

- **当** 会话数据被加密
- **那么** 加密后的数据必须无法在不知道密钥的情况下解密或读取

#### 场景:解密失败处理

- **当** 使用错误的密码尝试解密会话
- **那么** 系统必须返回解密失败错误并提示用户检查密码

### 需求:上传会话到云端

系统必须将压缩和加密后的会话数据上传到七牛云。

#### 场景:首次上传会话

- **当** 用户首次同步一个会话
- **那么** 系统必须创建新的会话ID,上传所有数据文件(meta.json、messages.json、context.json)

#### 场景:更新现有会话

- **当** 用户同步已存在于云端的会话
- **那么** 系统必须更新会话的时间戳和版本号,并覆盖云端文件

#### 场景:上传失败回滚

- **当** 会话数据上传过程中发生错误
- **那么** 系统必须清理已上传的部分文件,保持云端数据一致性

#### 场景:显示上传进度

- **当** 用户同步会话
- **那么** 系统必须显示上传进度百分比和预计剩余时间

### 需求:从云端下载会话

系统必须支持从七牛云下载指定会话的所有数据文件。

#### 场景:下载完整会话

- **当** 用户请求恢复指定会话
- **那么** 系统必须下载该会话的所有数据文件(meta.json、messages.json、context.json)

#### 场景:下载不完整会话

- **当** 云端会话缺少必需的数据文件
- **那么** 系统必须返回数据不完整错误并列出缺失的文件

#### 场景:显示下载进度

- **当** 用户恢复会话
- **那么** 系统必须显示下载进度百分比

### 需求:增量同步

系统必须支持增量同步,仅上传自上次同步后新增的消息和变更。

#### 场景:仅上传新消息

- **当** 用户在已同步的会话中添加了 5 条新消息
- **那么** 系统必须仅上传这 5 条新消息,不重新上传所有历史消息

#### 场景:检测本地变更

- **当** 用户触发增量同步
- **那么** 系统必须对比本地和云端的最后同步时间戳,识别新增或修改的内容

#### 场景:首次同步无增量

- **当** 会话从未同步过
- **那么** 系统必须执行完整同步,上传所有数据

### 需求:自动同步模式

系统必须支持后台自动同步,定期将会话变更上传到云端。

#### 场景:启用自动同步

- **当** 用户运行 `/sync-session --auto`
- **那么** 系统必须启动后台任务,每 5 分钟自动同步一次会话

#### 场景:基于消息数量触发同步

- **当** 会话新增超过 10 条消息
- **那么** 系统必须自动触发一次同步

#### 场景:禁用自动同步

- **当** 用户关闭自动同步
- **那么** 系统必须停止后台同步任务,仅允许手动同步

#### 场景:自动同步失败不中断工作

- **当** 后台自动同步因网络错误失败
- **那么** 系统必须记录错误日志但不打断用户当前操作,并在下次同步时重试

### 需求:同步状态追踪

系统必须追踪每个会话的同步状态。

#### 场景:记录最后同步时间

- **当** 会话成功同步到云端
- **那么** 系统必须记录同步时间戳和同步的消息数量

#### 场景:显示同步状态

- **当** 用户查看会话列表
- **那么** 系统必须显示每个会话的同步状态(已同步、未同步、同步中、同步失败)

#### 场景:检测本地未同步变更

- **当** 用户在已同步会话中添加了新消息但未同步
- **那么** 系统必须标记该会话为"有未同步变更"

## 修改需求

无

## 移除需求

无
