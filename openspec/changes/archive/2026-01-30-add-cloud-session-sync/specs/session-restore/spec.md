## 新增需求

### 需求:通过会话ID恢复会话

系统必须支持用户通过会话ID从云端恢复完整会话。

#### 场景:成功恢复会话

- **当** 用户提供有效的会话ID
- **那么** 系统必须从云端下载会话数据,解密解压,并在当前窗口恢复完整对话历史

#### 场景:恢复不存在的会话

- **当** 用户提供的会话ID在云端不存在
- **那么** 系统必须返回会话不存在错误并提示用户检查ID

#### 场景:恢复损坏的会话

- **当** 云端会话数据文件损坏或不完整
- **那么** 系统必须返回数据损坏错误并建议用户联系支持

### 需求:解密和解压会话数据

系统必须正确解密和解压从云端下载的会话数据。

#### 场景:使用正确密码解密

- **当** 用户提供正确的加密密码
- **那么** 系统必须成功解密会话数据并恢复原始内容

#### 场景:密码错误

- **当** 用户提供错误的加密密码
- **那么** 系统必须返回解密失败错误并允许用户重新输入密码

#### 场景:自动使用本地密钥

- **当** 会话使用自动生成的密钥加密且密钥存储在本地 keychain
- **那么** 系统必须自动使用该密钥解密,无需用户输入

#### 场景:解压数据

- **当** 会话数据被 GZIP 压缩
- **那么** 系统必须正确解压并验证数据完整性

### 需求:重建对话历史

系统必须在新设备上完整重建对话历史,让用户可以无缝继续对话。

#### 场景:恢复所有消息

- **当** 会话包含 100 条历史消息
- **那么** 系统必须按时间顺序恢复所有消息,包括用户消息和 AI 回复

#### 场景:恢复消息格式

- **当** 消息包含代码块、列表、链接等格式
- **那么** 系统必须保持原始格式不变

#### 场景:恢复附件和文件引用

- **当** 消息引用了代码片段或文件
- **那么** 系统必须恢复文件引用,如果本地存在相同路径的文件则关联

### 需求:重建工作上下文

系统必须恢复会话的工作上下文,包括项目路径、打开的文件等。

#### 场景:恢复项目路径

- **当** 会话关联了特定的项目路径
- **那么** 系统必须提示用户该会话原始的项目路径

#### 场景:恢复文件引用

- **当** 会话引用了多个源代码文件
- **那么** 系统必须列出所有引用的文件路径

#### 场景:本地路径不匹配

- **当** 新设备上的项目路径与原设备不同
- **那么** 系统必须允许用户映射路径或忽略路径差异

### 需求:验证会话完整性

系统必须验证恢复的会话数据是否完整且未被篡改。

#### 场景:校验数据哈希

- **当** 系统下载会话数据
- **那么** 系统必须验证数据的哈希值与元数据中记录的一致

#### 场景:检测数据篡改

- **当** 会话数据的哈希值不匹配
- **那么** 系统必须拒绝恢复并警告数据可能已被篡改

#### 场景:版本兼容性检查

- **当** 会话由旧版本 CodeBuddy 创建
- **那么** 系统必须检查版本兼容性,如果不兼容则提示用户升级或使用旧版本

### 需求:恢复进度反馈

系统必须向用户显示会话恢复的进度。

#### 场景:显示恢复步骤

- **当** 用户恢复会话
- **那么** 系统必须显示当前步骤(下载中、解密中、解压中、重建中)

#### 场景:显示下载进度

- **当** 系统下载大型会话数据
- **那么** 系统必须显示下载进度百分比

#### 场景:恢复完成通知

- **当** 会话成功恢复
- **那么** 系统必须显示成功消息,包括恢复的消息数量和会话创建时间

### 需求:多设备会话合并

系统必须支持在恢复会话时与本地已有会话合并。

#### 场景:恢复到空会话

- **当** 当前没有活动会话
- **那么** 系统必须创建新会话并恢复云端数据

#### 场景:合并到现有会话

- **当** 用户选择将云端会话合并到当前会话
- **那么** 系统必须将云端消息追加到当前会话末尾

#### 场景:替换当前会话

- **当** 用户选择用云端会话替换当前会话
- **那么** 系统必须清空当前会话并恢复云端数据

### 需求:离线恢复缓存

系统必须支持缓存最近恢复的会话,以便离线访问。

#### 场景:缓存恢复的会话

- **当** 用户成功从云端恢复会话
- **那么** 系统必须在本地缓存该会话数据

#### 场景:离线访问缓存会话

- **当** 用户在离线状态尝试访问已缓存的会话
- **那么** 系统必须从本地缓存加载会话,无需网络连接

#### 场景:缓存过期清理

- **当** 缓存的会话超过 30 天未访问
- **那么** 系统必须自动清理该缓存以释放存储空间

## 修改需求

无

## 移除需求

无
