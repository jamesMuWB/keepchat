## 新增需求

### 需求:检测多设备并发修改

系统必须检测同一会话在多个设备上同时被修改的情况。

#### 场景:检测到版本冲突

- **当** 设备A上传会话时,云端版本号比本地记录的版本号更新
- **那么** 系统必须识别为版本冲突并暂停上传

#### 场景:检测到时间戳冲突

- **当** 本地会话和云端会话的最后修改时间戳不一致
- **那么** 系统必须标记为潜在冲突

#### 场景:无冲突的正常同步

- **当** 云端版本号与本地记录一致
- **那么** 系统必须正常执行同步,无需冲突解决

### 需求:版本号管理

系统必须为每个会话维护版本号,每次修改后递增。

#### 场景:初始版本号

- **当** 会话首次创建
- **那么** 系统必须将版本号设置为 1

#### 场景:本地修改递增版本

- **当** 会话在本地被修改(新增消息)
- **那么** 系统必须将本地版本号递增 1

#### 场景:同步后更新版本

- **当** 会话成功同步到云端
- **那么** 系统必须将云端版本号更新为本地版本号

#### 场景:下载时记录版本

- **当** 从云端恢复会话
- **那么** 系统必须记录云端的版本号作为本地基准版本

### 需求:冲突提示和选择

系统必须向用户清晰展示冲突情况并提供解决选项。

#### 场景:显示冲突详情

- **当** 检测到冲突
- **那么** 系统必须显示本地版本和云端版本的详细信息(修改时间、设备、消息数量)

#### 场景:提供解决选项

- **当** 显示冲突详情后
- **那么** 系统必须提供三个选项:1)使用本地版本覆盖云端 2)使用云端版本覆盖本地 3)手动合并

#### 场景:用户选择超时

- **当** 用户在 30 秒内未选择解决方案
- **那么** 系统必须取消同步操作并保留本地数据

### 需求:保留本地版本策略

系统必须支持用户选择用本地版本覆盖云端。

#### 场景:强制上传本地版本

- **当** 用户选择"使用本地版本覆盖云端"
- **那么** 系统必须将本地数据上传到云端,忽略云端的更新

#### 场景:备份云端版本

- **当** 本地版本覆盖云端前
- **那么** 系统必须先备份云端版本到 `<session-id>-backup-<timestamp>/`,防止数据丢失

#### 场景:更新版本号

- **当** 本地版本成功覆盖云端
- **那么** 系统必须将云端版本号更新为本地版本号 + 1

### 需求:保留云端版本策略

系统必须支持用户选择用云端版本覆盖本地。

#### 场景:下载云端版本

- **当** 用户选择"使用云端版本覆盖本地"
- **那么** 系统必须从云端下载最新数据并替换本地会话

#### 场景:备份本地版本

- **当** 云端版本覆盖本地前
- **那么** 系统必须先将本地会话备份到本地存储,保留 7 天

#### 场景:更新本地版本号

- **当** 云端版本成功覆盖本地
- **那么** 系统必须将本地版本号更新为云端版本号

### 需求:手动合并策略

系统必须支持用户手动合并两个版本的会话数据。

#### 场景:显示差异对比

- **当** 用户选择"手动合并"
- **那么** 系统必须并排显示本地和云端的消息列表,高亮差异部分

#### 场景:选择保留的消息

- **当** 显示差异对比后
- **那么** 系统必须允许用户逐条选择保留本地消息、云端消息或两者都保留

#### 场景:合并消息排序

- **当** 用户选择两者都保留
- **那么** 系统必须按时间戳对所有消息重新排序

#### 场景:保存合并结果

- **当** 用户完成手动合并
- **那么** 系统必须将合并后的数据同时更新到本地和云端,版本号递增

### 需求:自动合并简单冲突

系统必须自动合并明显不冲突的情况。

#### 场景:仅一方有新消息

- **当** 本地有 5 条新消息,云端无更新
- **那么** 系统必须自动合并,无需用户干预

#### 场景:两边修改不重叠

- **当** 本地添加了消息 A,云端添加了消息 B,且时间戳不重叠
- **那么** 系统必须自动按时间戳合并两边的消息

#### 场景:相同的消息重复

- **当** 本地和云端包含相同内容和时间戳的消息
- **那么** 系统必须自动去重,仅保留一份

### 需求:冲突解决历史

系统必须记录所有冲突解决的历史。

#### 场景:记录冲突事件

- **当** 发生冲突并解决
- **那么** 系统必须记录冲突发生时间、涉及的设备、选择的解决策略

#### 场景:查看冲突历史

- **当** 用户运行 `/list-sessions --conflicts`
- **那么** 系统必须显示所有发生过冲突的会话及其解决记录

#### 场景:恢复冲突备份

- **当** 用户需要恢复之前冲突时的备份版本
- **那么** 系统必须允许用户查看并恢复任何备份版本

### 需求:防止数据丢失

系统必须确保冲突解决过程中不丢失任何数据。

#### 场景:冲突解决失败回滚

- **当** 冲突解决过程中发生错误
- **那么** 系统必须回滚到冲突解决前的状态,保持本地和云端数据不变

#### 场景:备份所有被覆盖的数据

- **当** 任何版本被覆盖
- **那么** 系统必须先创建备份,保留至少 7 天

#### 场景:数据一致性验证

- **当** 冲突解决完成
- **那么** 系统必须验证本地和云端数据的哈希值一致

## 修改需求

无

## 移除需求

无
