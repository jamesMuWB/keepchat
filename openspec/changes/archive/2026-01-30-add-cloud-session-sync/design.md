## 上下文

当前 AI 编程助手(Claude Code、Cursor、CodeBuddy CLI)的会话数据仅存储在本地设备,导致用户在切换设备时无法继续之前的对话,必须重新建立上下文。本设计旨在通过七牛云 Kodo 对象存储实现跨设备会话同步。

**当前状态**:

- 会话数据存储在本地文件系统或内存中
- 无跨设备访问能力
- 无云端备份机制

**约束**:

- 必须保证会话数据的隐私和安全性(加密传输和存储)
- 需要处理网络不稳定和离线场景
- 成本敏感,需要利用七牛云的免费额度(10GB 存储 + 10GB HTTP 流量/月)
- 会话数据可能较大(包含完整对话历史和文件引用)
- 需要处理多设备并发修改的冲突

**利益相关者**:

- 最终用户:需要简单易用的同步体验,无感知的跨设备切换
- 开发者:需要清晰的模块划分和可维护的代码结构

## 目标 / 非目标

**目标:**

- 实现会话数据的云端存储和跨设备同步
- 提供用户友好的 slash commands 接口(`/sync-session`, `/restore-session` 等)
- 确保会话数据的安全性(AES-256 加密)
- 支持自动同步和手动同步两种模式
- 处理多设备并发修改的冲突检测和解决
- 优化传输效率(GZIP 压缩,增量同步)
- 在七牛云免费额度内支持个人用户的日常使用

**非目标:**

- 不支持多个云存储提供商(仅七牛云)
- 不实现实时协作编辑(仅异步同步)
- 不支持会话的版本历史回溯(仅保留最新版本和冲突备份)
- 不实现会话分享功能(跨用户共享会话)
- 不处理超大型会话(>100MB)的优化(超出个人使用场景)

## 决策

### 决策 1: 云存储提供商 - 选择七牛云 Kodo

**选择**: 使用七牛云 Kodo 作为唯一的云存储后端

**理由**:

- **免费额度充足**: 10GB 存储 + 10GB HTTP 流量/月,个人使用足够(会话数据通常 <1MB/会话)
- **国内访问速度快**: 七牛云在国内有多个节点,访问延迟低
- **API 成熟**: 提供完善的 Node.js SDK,支持分片上传、断点续传等高级功能
- **S3 兼容性**: 虽然有自己的 SDK,但也支持 S3 协议,未来可扩展
- **成本可控**: 超出免费额度后,价格透明且相对便宜(存储 ¥0.148/GB/月)

**替代方案**:

- **Cloudflare R2**: 零出口流量费用,但国内访问速度慢,需要国际网络
- **AWS S3**: 功能强大但价格较高,免费额度较少,国内访问需要专线
- **阿里云 OSS**: 无免费额度,成本较高
- **本地 NAS/自建服务器**: 需要用户自行维护,复杂度高

**权衡**: 仅支持七牛云,用户必须注册七牛云账号。未来如需支持多云,需要重构存储层。

---

### 决策 2: 数据结构 - 会话数据分文件存储

**选择**: 将会话数据拆分为多个文件存储:

- `meta.json`: 会话元数据(ID、时间戳、设备、版本号、哈希值)
- `messages.json`: 对话历史(所有用户消息和 AI 回复)
- `context.json`: 工作上下文(项目路径、文件引用、任务状态)

**理由**:

- **增量同步**: 可以仅更新变化的文件(如仅 messages.json),而不是上传整个会话
- **并行操作**: 可以并行上传/下载多个文件,提升速度
- **灵活扩展**: 未来可以添加新的数据文件(如 attachments/)而不影响现有结构
- **故障恢复**: 如果某个文件上传失败,其他文件仍然可用

**替代方案**:

- **单文件存储**: 将所有数据打包到一个 JSON 文件
  - 优点: 简单,事务性强(要么全部成功,要么全部失败)
  - 缺点: 无法增量同步,大会话传输慢
- **数据库存储**: 使用云数据库(如 Supabase)
  - 优点: 支持复杂查询,实时同步
  - 缺点: 成本高,复杂度高,增加依赖

**权衡**: 多文件结构增加了代码复杂度(需要确保文件一致性),但换来了性能和灵活性。

---

### 决策 3: 加密方案 - AES-256-GCM + 密码/API key 双模式

**选择**: 使用 AES-256-GCM 算法,支持两种密钥模式:

1. **用户密码模式**: 用户提供密码,通过 PBKDF2(SHA-256, 100000 次迭代)派生密钥
2. **API key 配置模式**: 用户配置 `ENCRYPTION_API_KEY`,系统通过 SHA-256 派生 256 位密钥

**理由**:

- **安全性**: AES-256-GCM 提供机密性和完整性保护(认证加密),防止数据被篡改
- **灵活性**: 用户可以选择自己管理密码,或使用 API key 在多设备上保持一致
- **可部署性**: 无需系统 keychain 依赖,部署更简单
- **性能**: GCM 模式支持硬件加速,性能优于 CBC + HMAC 的组合

**替代方案**:

- **不加密**: 直接存储明文
  - 优点: 简单,无性能开销
  - 缺点: 会话数据包含敏感信息(代码、API Key 等),不加密不可接受
- **仅用户密码模式**: 要求所有用户设置密码
  - 优点: 安全性由用户控制
  - 缺点: 增加使用门槛,跨设备需记住密码
- **系统 keychain 自动密钥**: 使用系统凭据存储
  - 优点: 本机使用方便
  - 缺点: 跨设备不便,需要额外依赖
- **端到端加密(E2EE)**: 密钥永不离开客户端
  - 优点: 最高安全性
  - 缺点: 密钥管理复杂,用户忘记密码数据永久丢失

**权衡**: API key 方式便于跨设备一致,但密钥落地在配置中,需要提醒用户妥善保管。密码模式更安全,但增加了使用复杂度。

---

### 决策 4: 压缩算法 - GZIP

**选择**: 使用 GZIP 压缩 JSON 数据后再加密上传

**理由**:

- **压缩率高**: JSON 数据高度可压缩,GZIP 可达到 70-80% 的压缩率
- **标准化**: GZIP 是广泛使用的标准,Node.js 内置 `zlib` 模块支持
- **节省流量**: 减少上传下载的数据量,在免费额度内支持更多会话

**替代方案**:

- **Brotli**: 压缩率更高(~85-90%)
  - 优点: 更好的压缩效果
  - 缺点: 压缩速度较慢,解压速度与 GZIP 相当
- **不压缩**: 直接上传 JSON
  - 优点: 简单,无 CPU 开销
  - 缺点: 浪费流量和存储空间

**权衡**: GZIP 在压缩率和速度之间取得平衡。如果未来发现会话数据极大,可以考虑切换到 Brotli。

---

### 决策 5: 冲突解决策略 - 版本号 + 用户选择

**选择**: 使用版本号检测冲突,发生冲突时由用户选择解决策略:

1. 使用本地版本覆盖云端
2. 使用云端版本覆盖本地
3. 手动合并(显示差异,逐条选择)

**理由**:

- **明确性**: 版本号清晰标识会话的状态,易于检测冲突
- **安全性**: 让用户决定如何处理冲突,避免自动覆盖导致数据丢失
- **备份机制**: 覆盖前自动备份被覆盖的版本,可恢复

**替代方案**:

- **最后写入获胜(LWW)**: 自动使用时间戳较新的版本
  - 优点: 无需用户干预
  - 缺点: 可能丢失用户在旧设备上的工作
- **操作转换(OT)**: 自动合并两边的变更
  - 优点: 类似 Google Docs 的实时协作体验
  - 缺点: 实现复杂,会话数据结构不规则难以应用 OT
- **CRDT(无冲突复制数据类型)**: 保证最终一致性
  - 优点: 自动合并,无冲突
  - 缺点: 需要重新设计数据结构,复杂度极高

**权衡**: 用户选择策略增加了用户操作,但避免了数据丢失的风险。自动合并虽然方便,但对于非结构化的对话数据难以实现。

---

### 决策 6: 同步触发方式 - 手动 + 可选自动

**选择**: 默认手动同步(用户运行 `/sync-session`),可选启用自动同步(`--auto` 参数)

**理由**:

- **用户控制**: 手动同步让用户明确知道何时上传数据,符合隐私预期
- **节省流量**: 避免频繁的自动同步浪费流量
- **灵活性**: 自动同步作为可选功能,满足不同用户需求

**替代方案**:

- **仅手动同步**: 完全由用户控制
  - 优点: 最简单,用户完全控制
  - 缺点: 用户可能忘记同步,导致设备间数据不一致
- **仅自动同步**: 后台自动同步,无需用户干预
  - 优点: 最方便,类似 Dropbox 的体验
  - 缺点: 可能在用户不知情时上传敏感数据
- **实时同步**: 每条消息立即同步
  - 优点: 最及时
  - 缺点: 频繁网络请求,浪费流量,增加延迟

**权衡**: 手动同步增加了用户操作,但符合隐私优先的原则。自动同步可选,满足便利性需求。

---

### 决策 7: 模块架构 - 分层设计

**选择**: 采用分层架构:

```
┌─────────────────────────────────────────┐
│  Slash Commands Layer                   │
│  (/sync-session, /restore-session...)   │
└─────────────┬───────────────────────────┘
              │
┌─────────────▼───────────────────────────┐
│  Session Sync Engine                    │
│  (collect, compress, encrypt, sync)     │
└─────────────┬───────────────────────────┘
              │
┌─────────────▼───────────────────────────┐
│  Qiniu Storage Adapter                  │
│  (upload, download, list, delete)       │
└─────────────┬───────────────────────────┘
              │
┌─────────────▼───────────────────────────┐
│  Qiniu SDK (qiniu package)              │
└─────────────────────────────────────────┘
```

**理由**:

- **关注点分离**: 每层职责清晰,易于测试和维护
- **可扩展性**: 未来如需支持其他云存储,仅需替换 Qiniu Storage Adapter 层
- **复用性**: Session Sync Engine 可被其他功能复用(如导出会话)

**替代方案**:

- **单体模块**: 所有逻辑在一个模块中
  - 优点: 简单,快速实现
  - 缺点: 耦合严重,难以测试和扩展
- **微服务架构**: 每个功能独立服务
  - 优点: 最强的解耦和可扩展性
  - 缺点: 过度设计,增加复杂度和运维成本

**权衡**: 分层架构在复杂度和灵活性间取得平衡,适合当前规模。

---

### 决策 8: 会话 ID 生成 - UUID v4

**选择**: 使用 UUID v4 生成唯一的会话 ID

**理由**:

- **全局唯一**: UUID v4 碰撞概率极低,无需中心化分配
- **无序性**: UUID v4 随机生成,不泄露时间或设备信息
- **标准化**: 广泛使用的标准,易于识别和处理

**替代方案**:

- **自增 ID**: 1, 2, 3...
  - 优点: 简短,有序
  - 缺点: 需要中心化分配,泄露会话数量信息
- **ULID**: 时间戳 + 随机数,有序
  - 优点: 可排序,比 UUID 更短
  - 缺点: 泄露创建时间,库支持较少
- **nanoid**: 更短的随机 ID
  - 优点: URL 友好,更短
  - 缺点: 非标准,碰撞概率略高

**权衡**: UUID v4 虽然较长(36 字符),但标准化和安全性更好。

## 风险 / 权衡

### 风险 1: 七牛云服务中断

**风险**: 七牛云服务故障或维护,导致用户无法同步会话

**缓解措施**:

- 本地会话仍然可用,同步功能仅作为备份和跨设备访问
- 实现离线队列,网络恢复后自动重试同步
- 在文档中提醒用户定期导出会话到本地备份

---

### 风险 2: 密钥丢失导致数据无法解密

**风险**: 用户忘记密码或丢失 `ENCRYPTION_API_KEY`,导致云端会话无法解密

**缓解措施**:

- 首次设置加密时,强烈建议用户导出密钥备份
- 提供密钥恢复机制(安全问题、备用邮箱等) - **非目标,未来考虑**
- 在文档中明确说明密钥丢失的后果

---

### 风险 3: 超出免费额度

**风险**: 用户会话数据超过 10GB 或流量超过 10GB/月,产生费用

**缓解措施**:

- 实现存储空间监控,接近限额时警告用户
- 提供会话清理功能,删除旧会话释放空间
- 在文档中说明成本预估和超额费用

---

### 风险 4: 冲突解决错误导致数据丢失

**风险**: 用户误选覆盖策略,或手动合并时操作错误,导致数据丢失

**缓解措施**:

- 所有覆盖操作前自动备份被覆盖的版本,保留 7 天
- 手动合并时提供预览和确认步骤
- 提供冲突历史查看和备份恢复功能

---

### 风险 5: 性能问题 - 大型会话同步慢

**风险**: 超大会话(1000+ 条消息)同步耗时长,影响用户体验

**缓解措施**:

- 实现增量同步,仅上传新增或修改的数据
- 使用 GZIP 压缩减少传输数据量
- 使用七牛云的分片上传功能,支持断点续传
- 显示进度条,让用户了解同步状态

---

### 风险 6: 安全性 - 中间人攻击或数据泄露

**风险**: 数据在传输或存储过程中被窃取

**缓解措施**:

- 所有网络传输使用 HTTPS
- 数据在上传前加密,云端仅存储密文
- 使用 AES-256-GCM 提供完整性验证,防止篡改
- AccessKey/SecretKey/ENCRYPTION_API_KEY 需最小化暴露,配置文件中应加密或限制权限

---

### 权衡 1: 仅支持七牛云 vs 多云支持

**权衡**: 仅支持七牛云简化了实现和维护,但限制了用户选择

**影响**:

- 用户必须注册七牛云账号
- 国外用户访问速度可能较慢
- 未来如需支持其他云存储,需要重构存储层

---

### 权衡 2: 手动同步为主 vs 自动同步为主

**权衡**: 手动同步保护隐私,但增加用户操作负担

**影响**:

- 用户可能忘记同步,导致设备间数据不一致
- 自动同步虽然方便,但可能在用户不知情时上传数据
- 折中方案:默认手动,提供自动同步选项

---

### 权衡 3: 版本冲突由用户解决 vs 自动合并

**权衡**: 用户解决冲突更安全,但增加了用户负担

**影响**:

- 用户需要理解冲突的含义和解决策略
- 自动合并虽然方便,但对于非结构化对话数据难以实现
- 提供简单冲突的自动合并,复杂冲突交由用户决策

## 迁移计划

### 阶段 1: 实现核心功能(MVP)

1. 实现七牛云存储适配器(上传、下载、列表、删除)
2. 实现会话数据收集和序列化
3. 实现 AES-256-GCM 加密和 GZIP 压缩
4. 实现 `/sync-session` 和 `/restore-session` 命令
5. 单元测试和集成测试

### 阶段 2: 增强功能

1. 实现 `/list-sessions` 和 `/delete-session` 命令
2. 实现冲突检测和解决机制
3. 实现增量同步优化
4. 实现自动同步模式

### 阶段 3: 用户体验优化

1. 实现首次使用引导(配置七牛云)
2. 实现进度反馈和错误提示
3. 实现存储空间监控和清理工具
4. 编写用户文档和使用教程

### 部署策略

- 功能以 feature flag 形式发布,默认关闭
- 内部测试通过后,逐步开放给用户
- 提供一键配置脚本,简化七牛云设置

### 回滚策略

- 如果发现严重 bug,可以通过 feature flag 快速禁用功能
- 本地会话数据不受影响,回滚不会导致数据丢失
- 云端数据保留,用户可以稍后恢复

## 未决问题

1. **会话数据保留策略**: 云端会话保留多久?是否需要自动清理超过 N 天未访问的会话?
   - 建议: 提供配置项,默认保留 90 天,用户可自定义

2. **跨账号访问**: 是否支持多个 CodeBuddy 账号共享同一个七牛云存储?
   - 建议: 暂不支持,每个账号独立配置,避免数据混淆

3. **会话分享**: 是否需要支持将会话分享给其他用户(生成公开链接)?
   - 建议: 非目标,涉及权限管理和安全问题,未来独立规划

4. **移动端支持**: 是否需要支持移动端(iOS/Android)访问会话?
   - 建议: 非目标,当前专注桌面端,移动端未来考虑

5. **实时同步**: 是否需要支持 WebSocket 实时同步(类似 Google Docs)?
   - 建议: 非目标,复杂度高,当前异步同步已满足需求
