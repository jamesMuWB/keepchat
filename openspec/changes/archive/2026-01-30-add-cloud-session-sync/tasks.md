## 1. 项目设置和依赖

- [x] 1.1 安装七牛云 Node.js SDK (`npm install qiniu`)
- [x] 1.2 创建项目目录结构 (`src/qiniu/`, `src/session-sync/`, `src/encryption/`)
- [x] 1.3 添加 TypeScript 类型定义文件
- [x] 1.4 配置 ESLint 和 Prettier 规则

## 2. 七牛云存储适配器 (qiniu-storage)

- [x] 2.1 实现七牛云配置管理模块 (读取 AccessKey、SecretKey、Bucket、Region)
- [x] 2.2 实现七牛云认证和初始化客户端
- [x] 2.3 实现文件上传功能 (支持普通上传和分片上传)
- [x] 2.4 实现文件下载功能 (支持断点续传)
- [x] 2.5 实现文件列表查询功能 (支持前缀过滤和分页)
- [x] 2.6 实现文件删除功能 (支持单个和批量删除)
- [x] 2.7 实现存储空间使用量查询功能
- [x] 2.8 实现网络错误处理和自动重试机制 (最多 3 次)
- [x] 2.9 编写七牛云存储适配器的单元测试

## 3. 会话数据加密模块 (session-encryption)

- [x] 3.1 实现 AES-256-GCM 加密函数 (生成随机 IV 和认证标签)
- [x] 3.2 实现 AES-256-GCM 解密函数 (验证认证标签)
- [x] 3.3 实现用户密码模式: PBKDF2 密钥派生 (SHA-256, 100000 次迭代)
- [x] 3.4 实现自动密钥模式: 生成随机密钥
- [x] 3.5 实现加密 API key 配置读取与存储 (环境变量 + 配置文件)
- [x] 3.6 实现 API key 导出和导入功能 (Base64 编码)
- [x] 3.7 实现密钥轮换功能
- [x] 3.8 实现加密元数据管理 (盐、IV、算法标识、认证标签)
- [x] 3.9 实现密码强度验证 (最少 8 位,包含字母和数字)
- [x] 3.10 编写加密模块的单元测试

## 4. 会话数据压缩模块

- [x] 4.1 实现 GZIP 压缩功能 (使用 Node.js 内置 zlib)
- [x] 4.2 实现 GZIP 解压功能
- [x] 4.3 实现流式压缩功能 (处理大文件)
- [x] 4.4 编写压缩模块的单元测试

## 5. 会话同步引擎 (session-sync-engine)

- [x] 5.1 实现会话数据收集功能 (对话历史、工作上下文、文件引用、元数据)
- [x] 5.2 实现会话数据序列化为 JSON
- [x] 5.3 实现会话数据分文件存储 (meta.json、messages.json、context.json)
- [x] 5.4 实现同步流程: 收集 → 压缩 → 加密 → 上传
- [x] 5.5 实现下载流程: 下载 → 解密 → 解压 → 解析
- [x] 5.6 实现增量同步: 对比时间戳,仅上传变更部分
- [x] 5.7 实现同步状态追踪 (最后同步时间、同步的消息数量)
- [x] 5.8 实现上传进度反馈 (百分比)
- [x] 5.9 实现下载进度反馈 (百分比)
- [x] 5.10 实现自动同步模式 (后台任务,每 5 分钟或每 10 条新消息触发)
- [x] 5.11 实现同步失败处理和错误日志
- [x] 5.12 编写会话同步引擎的单元测试和集成测试

## 6. 会话恢复功能 (session-restore)

- [x] 6.1 实现通过会话 ID 下载会话数据
- [x] 6.2 实现会话数据解密和解压
- [x] 6.3 实现会话完整性验证 (哈希值校验)
- [x] 6.4 实现重建对话历史 (恢复所有消息和格式)
- [x] 6.5 实现重建工作上下文 (项目路径、文件引用)
- [x] 6.6 实现路径映射功能 (处理不同设备路径差异)
- [x] 6.7 实现多设备会话合并 (恢复到空会话、合并到现有会话、替换当前会话)
- [x] 6.8 实现恢复进度反馈 (显示当前步骤和进度)
- [x] 6.9 实现离线恢复缓存 (缓存最近恢复的会话)
- [x] 6.10 实现缓存过期清理 (超过 30 天未访问自动清理)
- [x] 6.11 编写会话恢复功能的单元测试

## 7. 冲突检测和解决 (conflict-resolution)

- [x] 7.1 实现版本号管理 (初始化、递增、同步更新)
- [x] 7.2 实现冲突检测: 对比本地和云端版本号
- [x] 7.3 实现冲突详情显示 (本地版本 vs 云端版本)
- [x] 7.4 实现冲突解决策略: 保留本地版本覆盖云端
- [x] 7.5 实现冲突解决策略: 保留云端版本覆盖本地
- [x] 7.6 实现冲突解决策略: 手动合并 (显示差异对比)
- [x] 7.7 实现自动合并简单冲突 (仅一方有新消息、不重叠修改)
- [x] 7.8 实现冲突备份机制 (覆盖前自动备份,保留 7 天)
- [x] 7.9 实现冲突解决历史记录
- [x] 7.10 实现备份版本恢复功能
- [x] 7.11 编写冲突解决模块的单元测试

## 8. Slash Commands 实现 (sync-commands)

- [x] 8.1 创建 `.codebuddy/commands/sync-session.md` 命令文件
- [x] 8.2 实现 `/sync-session` 命令逻辑 (调用同步引擎)
- [x] 8.3 实现 `/sync-session --force` 参数 (强制覆盖云端)
- [x] 8.4 实现 `/sync-session --auto` 参数 (启用自动同步)
- [x] 8.5 创建 `.codebuddy/commands/restore-session.md` 命令文件
- [x] 8.6 实现 `/restore-session <session-id>` 命令逻辑
- [x] 8.7 实现恢复会话时的密码输入提示
- [x] 8.8 创建 `.codebuddy/commands/list-sessions.md` 命令文件
- [x] 8.9 实现 `/list-sessions` 命令逻辑 (显示所有云端会话)
- [x] 8.10 实现 `/list-sessions --limit N` 参数 (限制显示数量)
- [x] 8.11 实现 `/list-sessions --search <keyword>` 参数 (搜索会话)
- [x] 8.12 创建 `.codebuddy/commands/delete-session.md` 命令文件
- [x] 8.13 实现 `/delete-session <session-id>` 命令逻辑
- [x] 8.14 实现删除前确认提示
- [x] 8.15 实现 `/delete-session --force` 参数 (跳过确认)
- [x] 8.16 实现命令参数验证 (会话 ID 格式、参数冲突检查)
- [x] 8.17 实现命令执行状态显示 (进度条、加载动画)
- [x] 8.18 实现命令错误处理 (网络错误、认证错误、权限错误、存储空间不足)
- [x] 8.19 实现 `--help` 参数显示命令用法

## 9. 密钥管理 Commands

- [x] 9.1 创建 `.codebuddy/commands/export-key.md` 命令文件
- [x] 9.2 实现 `/export-key` 命令逻辑 (导出 API key 为 Base64)
- [x] 9.3 创建 `.codebuddy/commands/import-key.md` 命令文件
- [x] 9.4 实现 `/import-key <base64-key>` 命令逻辑 (写入本地配置)
- [x] 9.5 创建 `.codebuddy/commands/rotate-key.md` 命令文件
- [x] 9.6 实现 `/rotate-key` 命令逻辑 (生成新 API key 并重新加密所有会话)

## 10. 配置管理

- [x] 10.1 设计配置文件结构 (`.codebuddy/qiniu-config.json`, `.codebuddy/encryption-config.json`)
- [x] 10.2 实现配置文件读取和写入
- [x] 10.3 实现配置验证 (检查必需字段)
- [x] 10.4 实现配置加密存储 (AccessKey、SecretKey、ENCRYPTION_API_KEY)
- [x] 10.5 实现首次使用引导流程 (提示用户配置七牛云与 ENCRYPTION_API_KEY)
- [x] 10.6 实现配置更新命令 (`/configure-qiniu`, `/configure-encryption`)

## 11. 用户体验优化

- [x] 11.1 实现友好的错误提示消息
- [x] 11.2 实现存储空间监控 (接近 9GB 时警告)
- [x] 11.3 实现会话清理工具 (`/cleanup-sessions` 命令,删除旧会话)
- [x] 11.4 实现同步成功通知 (显示会话 ID、消息数量、上传大小)
- [x] 11.5 实现恢复成功通知 (显示消息数量、原始设备、创建时间)
- [x] 11.6 实现离线检测和优雅降级 (离线时提示,不尝试连接)
- [x] 11.7 实现命令执行可中断 (Ctrl+C 优雅中止)

## 12. 文档和示例

- [x] 12.1 编写用户使用文档 (`docs/cloud-session-sync.md`)
- [x] 12.2 编写七牛云配置指南 (注册账号、创建 Bucket、获取密钥)
- [x] 12.3 编写常见问题解答 (FAQ)
- [x] 12.4 编写开发者文档 (模块设计、API 接口)
- [x] 12.5 提供示例配置文件

## 13. 测试和质量保证

- [x] 13.1 编写端到端测试: 完整的同步和恢复流程
- [x] 13.2 编写冲突场景测试: 多设备并发修改
- [x] 13.3 编写加密安全性测试: 验证加密强度和数据保护
- [x] 13.4 编写性能测试: 大型会话(1000+ 条消息)的同步速度
- [x] 13.5 编写网络异常测试: 模拟网络中断、超时、慢速连接
- [x] 13.6 编写存储空间限制测试: 超出免费额度的处理
- [x] 13.7 代码审查和重构

## 14. 部署和发布

- [ ] 14.1 配置 feature flag (默认关闭)
- [ ] 14.2 内部测试 (团队成员试用)
- [ ] 14.3 Beta 测试 (邀请部分用户测试)
- [ ] 14.4 收集用户反馈并优化
- [ ] 14.5 正式发布 (启用 feature flag)
- [ ] 14.6 监控错误日志和用户反馈
- [ ] 14.7 编写发布公告和更新日志
